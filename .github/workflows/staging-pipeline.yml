name: Staging Pipeline

on:
  push:
    branches: [develop]
    paths:
      - 'cat-house-backend/**'
      - '.github/workflows/staging-pipeline.yml'
  pull_request:
    branches: [develop]
    paths:
      - 'cat-house-backend/**'
  workflow_dispatch:

env:
  AWS_REGION: sa-east-1
  ENVIRONMENT: staging
  CLUSTER_NAME: cat-house-staging
  IMAGE_TAG: staging

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth-service, catalog-service, installation-service, proxy-service]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'cat-house-backend/${{ matrix.service }}/requirements.txt'
    
    - name: Install dependencies
      working-directory: cat-house-backend/${{ matrix.service }}
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio black pylint mypy httpx
    
    - name: Run linting (black)
      working-directory: cat-house-backend/${{ matrix.service }}
      run: |
        black --check app/
    
    - name: Run linting (pylint)
      working-directory: cat-house-backend/${{ matrix.service }}
      run: |
        pylint app/ --max-line-length=100 --disable=C,W0621,W0613,E1101,W0122,R1715,R0903
    
    - name: Run tests
      working-directory: cat-house-backend/${{ matrix.service }}
      env:
        DATABASE_URL: ${{ secrets.NEON_TEST_DATABASE_URL }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        ENVIRONMENT: test
      run: |
        pytest tests/ --cov=app --cov-report=xml --cov-report=term -v
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./cat-house-backend/${{ matrix.service }}/coverage.xml
        flags: ${{ matrix.service }}
        name: ${{ matrix.service }}-coverage
        fail_ci_if_error: false

  build:
    needs: test
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth-service, catalog-service, installation-service, proxy-service]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        SERVICE: ${{ matrix.service }}
      run: |
        echo "Building image for $SERVICE from develop branch"
        docker build \
          -t $ECR_REGISTRY/cat-house/$SERVICE:${{ github.sha }} \
          -t $ECR_REGISTRY/cat-house/$SERVICE:${{ env.IMAGE_TAG }} \
          -f cat-house-backend/$SERVICE/Dockerfile \
          cat-house-backend/$SERVICE
        
        echo "Pushing images for $SERVICE"
        docker push $ECR_REGISTRY/cat-house/$SERVICE:${{ github.sha }}
        docker push $ECR_REGISTRY/cat-house/$SERVICE:${{ env.IMAGE_TAG }}
        
        echo "✅ Successfully pushed $SERVICE:${{ env.IMAGE_TAG }}"

  migrate:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Run database migrations
      env:
        DATABASE_URL: ${{ secrets.NEON_STAGING_DATABASE_URL }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        ENVIRONMENT: staging
      run: |
        echo "Running database migrations via GitHub Actions..."
        
        # Auth service migrations (auth schema)
        echo "[1/3] Running auth-service migrations..."
        cd cat-house-backend/auth-service
        pip install -r requirements.txt alembic
        alembic upgrade head
        
        # Catalog service migrations (catalog schema)
        echo "[2/3] Running catalog-service migrations..."
        cd ../catalog-service
        pip install -r requirements.txt alembic
        alembic upgrade head
        
        # Installation service migrations (installation schema)
        echo "[3/3] Running installation-service migrations..."
        cd ../installation-service
        pip install -r requirements.txt alembic
        alembic upgrade head
        
        echo "All migrations completed successfully"

  deploy-backend:
    needs: migrate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth-service, catalog-service, installation-service, proxy-service]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Verify Docker image exists in ECR
      run: |
        echo "Verifying that Docker image exists for ${{ matrix.service }}..."
        
        if aws ecr describe-images \
          --repository-name cat-house/${{ matrix.service }} \
          --image-ids imageTag=${{ env.IMAGE_TAG }} \
          --region ${{ env.AWS_REGION }} > /dev/null 2>&1; then
          echo "✅ Image found: cat-house/${{ matrix.service }}:${{ env.IMAGE_TAG }}"
        else
          echo "❌ ERROR: Docker image not found in ECR"
          echo "Expected image: cat-house/${{ matrix.service }}:${{ env.IMAGE_TAG }}"
          exit 1
        fi
    
    - name: Get current task definition
      id: get-task-def
      run: |
        echo "Fetching current task definition for ${{ matrix.service }}..."
        aws ecs describe-task-definition \
          --task-definition cat-house-staging-${{ matrix.service }} \
          --query 'taskDefinition' > task-def.json
    
    - name: Inject secrets and register new task definition
      id: register-task-def
      env:
        DATABASE_URL: ${{ secrets.NEON_STAGING_DATABASE_URL }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      run: |
        echo "Injecting secrets into task definition..."
        
        jq --arg db_url "$DATABASE_URL" \
           --arg jwt_secret "$JWT_SECRET" \
           --arg enc_key "$ENCRYPTION_KEY" \
           '.containerDefinitions[0].environment += [
             {"name":"DATABASE_URL","value":$db_url},
             {"name":"JWT_SECRET","value":$jwt_secret},
             {"name":"ENCRYPTION_KEY","value":$enc_key}
           ] | del(.taskDefinitionArn,.revision,.status,.requiresAttributes,.compatibilities,.registeredAt,.registeredBy)' \
           task-def.json > new-task-def.json
        
        NEW_TASK_ARN=$(aws ecs register-task-definition \
          --cli-input-json file://new-task-def.json \
          --query 'taskDefinition.taskDefinitionArn' \
          --output text)
        
        echo "task_arn=$NEW_TASK_ARN" >> $GITHUB_OUTPUT
        echo "Registered new task definition: $NEW_TASK_ARN"
    
    - name: Update ECS service
      run: |
        echo "Deploying ${{ matrix.service }} to staging..."
        
        aws ecs update-service \
          --cluster ${{ env.CLUSTER_NAME }} \
          --service cat-house-staging-${{ matrix.service }} \
          --task-definition ${{ steps.register-task-def.outputs.task_arn }} \
          --force-new-deployment
        
        echo "Service ${{ matrix.service }} deployment initiated"
    
    - name: Wait for service stability
      run: |
        echo "Waiting for ${{ matrix.service }} to become stable..."
        
        aws ecs wait services-stable \
          --cluster ${{ env.CLUSTER_NAME }} \
          --services cat-house-staging-${{ matrix.service }}
        
        echo "Service ${{ matrix.service }} is stable"
    
    - name: Verify health check
      run: |
        SERVICE_NAME=$(echo "${{ matrix.service }}" | sed 's/-service$//')
        
        # Staging ALB health endpoint (updated after Terraform migration)
        HEALTH_URL="http://cat-house-staging-alb-1968126506.sa-east-1.elb.amazonaws.com/api/v1/${SERVICE_NAME}/health"
        
        echo "Health check URL: $HEALTH_URL"
        echo "Waiting for service to be fully operational..."
        
        for i in {1..10}; do
          echo "Attempt $i/10..."
          if curl -f -s "$HEALTH_URL" --connect-timeout 5 --max-time 10; then
            echo "✅ Health check passed for ${{ matrix.service }}"
            exit 0
          fi
          echo "Health check failed, retrying in 15s..."
          sleep 15
        done
        
        echo "❌ Health check failed after 10 attempts (2.5 minutes)"
        echo "Service may need more time to initialize or check CloudWatch logs for errors"
        exit 1

  deploy-frontend:
    needs: deploy-backend
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Build frontend static export
      working-directory: frontend
      env:
        EXPO_PUBLIC_API_URL: https://chapi-staging.gamificator.click
      run: |
        npm install --legacy-peer-deps
        npx expo export --platform web
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Sync to S3
      run: |
        echo "Syncing frontend to S3..."
        aws s3 sync frontend/dist/ s3://cat-house-frontend-staging --delete
        echo "Frontend synced to S3"
    
    - name: Invalidate CloudFront cache
      run: |
        echo "Invalidating CloudFront cache..."
        aws cloudfront create-invalidation \
          --distribution-id ${{ secrets.CLOUDFRONT_STAGING_ID }} \
          --paths "/*"
        echo "CloudFront cache invalidated"
