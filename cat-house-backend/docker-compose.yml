version: '3.8'

# Local Development Setup
# This docker-compose includes PostgreSQL and nginx for complete local development.
# For cloud-only development, use .env with Neon DATABASE_URL.
# For local development, use .env.local with postgres://catuser:catpass@postgres:5432/cathouse

services:
  # PostgreSQL Database (for local development)
  postgres:
    image: postgres:17-alpine
    container_name: cathouse-postgres
    environment:
      POSTGRES_USER: catuser
      POSTGRES_PASSWORD: catpass
      POSTGRES_DB: cathouse
    ports:
      - "5435:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - cathouse-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U catuser -d cathouse"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
  # Auth Service
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: cathouse-auth
    ports:
      - "8005:8005"
    env_file:
      - ./auth-service/.env.local
    volumes:
      - ./auth-service/app:/app/app:ro
    networks:
      - cathouse-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # Catalog Service
  catalog-service:
    build:
      context: ./catalog-service
      dockerfile: Dockerfile
    container_name: cathouse-catalog
    ports:
      - "8002:8002"
    env_file:
      - ./catalog-service/.env.local
    volumes:
      - ./catalog-service/app:/app/app:ro
    networks:
      - cathouse-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # Installation Service
  installation-service:
    build:
      context: ./installation-service
      dockerfile: Dockerfile
    container_name: cathouse-installation
    ports:
      - "8003:8003"
    env_file:
      - ./installation-service/.env.local
    volumes:
      - ./installation-service/app:/app/app:ro
    networks:
      - cathouse-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # Proxy Service
  proxy-service:
    build:
      context: ./proxy-service
      dockerfile: Dockerfile
    container_name: cathouse-proxy
    ports:
      - "8004:8004"
    env_file:
      - ./proxy-service/.env.local
    volumes:
      - ./proxy-service/app:/app/app:ro
    networks:
      - cathouse-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # Health Aggregator Service
  # Note: This service should be deployed separately and made publicly accessible
  # for AWS API Gateway to reach it. The URL should be configured in terraform.tfvars
  health-aggregator:
    build:
      context: ./health-aggregator
      dockerfile: Dockerfile
    container_name: cathouse-health
    ports:
      - "8006:8006"
    networks:
      - cathouse-network
    depends_on:
      - auth-service
      - catalog-service
      - installation-service
      - proxy-service
    restart: unless-stopped

  # Nginx API Gateway (for local development)
  nginx:
    image: nginx:alpine
    container_name: cathouse-nginx
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.local.conf:/etc/nginx/nginx.conf:ro
    networks:
      - cathouse-network
    depends_on:
      - auth-service
      - catalog-service
      - installation-service
      - proxy-service
      - health-aggregator
    restart: unless-stopped

networks:
  cathouse-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local

# Local Development:
# - Use .env.local files with DATABASE_URL=postgresql+asyncpg://catuser:catpass@postgres:5432/cathouse
# - Access API via http://localhost:8080/api
# - Run migrations: docker-compose exec auth-service alembic upgrade head
#
# Cloud Development (Staging/Production):
# - Infrastructure managed by AWS (ECS, ALB, RDS/Neon)
# - See terraform/ directory for infrastructure as code
# - CI/CD via GitHub Actions (.github/workflows/staging-pipeline.yml)
